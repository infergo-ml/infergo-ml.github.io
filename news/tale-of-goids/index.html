<!DOCTYPE html>
<html class="nojs" lang="en-GB" dir="ltr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>The Tale of GoIDs – Infergo – Go programs that learn</title>

<meta name="created" content="2019-04-01T15:19:22+0300">
<meta name="modified" content="2019-04-01T15:19:22+0300">
<meta name="author" content="David Tolpin">
<meta name="contact" content="david.tolpin@gmail.com">
<meta property="og:site_name" content="Infergo – Go programs that learn">
<meta property="og:title" content="The Tale of GoIDs">
<meta property="og:url" content="https://infergo.org/news/tale-of-goids/">
<meta property="og:type" content="article">
<meta property="og:image" content="https://infergo.org/apple-touch-icon.png">
<meta name="generator" content="Hugo 0.152.2">



<link rel="canonical" href="https://infergo.org/news/tale-of-goids/">

<link rel="apple-touch-icon" href="/apple-touch-icon.png">

<link rel="stylesheet" href="/css/styles.d13ddd933162a6d5541bfe958cbb8d761047ea95dac664677d688b5f2e6fcc99.css">
<link rel="stylesheet" href="/css/mobilemenu.295c7ca420e20bb22a98ef9b836cdd291aec4bac9f10e6369bd3ef17f539a522.css" media="screen">
<link rel="stylesheet" href="/css/print.c9925dbab6fd256f753b0319c569e85f28a89b8cbd71238bde2452f74dcdf761.css" media="print">

<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "WebPage",
    "headline": "The Tale of GoIDs",
    "datePublished": "2019-04-01T15:19:22+03:00",
    "dateModified": "2019-04-01T15:19:22+03:00",
    "url" : "https://infergo.org/news/tale-of-goids/",
    
    "image" : "https://infergo.org/apple-touch-icon.png",
    "author": {
      "@type": "Person",
      "name": "David Tolpin"
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://infergo.org/"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Infergo – Go programs that learn",
      "logo" : {
        "@type": "ImageObject",
        "url": "https://infergo.org/apple-touch-icon.png"
      },
      "url": "https://infergo.org/"
    }
  }
</script>

<script>
(()=>{(function(){document.querySelector("html").classList.replace("nojs","js")})();})();

</script>

<script defer src="/js/mobilemenu.7ce1f75fd1d49cd683a008352ad9001f800349629be01d531a19c02b5a84817b.js"></script>
<script defer src="/js/script.f2979a93a325fecf9605263bd141398a311c8e23388ed7dcff74f92f7e632866.js"></script>






</head>

<body class="single-page">
<div class="page layout__page layout__sidebar-second">
<header class="header layout__header">
<a href="/" title="Home" rel="home" class="header__logo">
<img src="/images/logo.png" width="64" alt="Home" class="header__logo-image">
</a>
<h1 class="header__site-name">
<a href="/" title="Home" class="header__site-link" rel="home"><span>Infergo – Go programs that learn</span></a>
</h1>
<div class="region header__region">
</div>
</header>

<nav class="main-menu mx--xs layout__navigation" aria-label="Main menu">
<ul class="flex-inline mx--0">
<li><a href="/"><span>Home</span></a></li>
<li><a href="/start/"><span>Getting started</span></a></li>
<li><a href="/guide/"><span>Guide</span></a></li>
<li><a href="/examples/"><span>Examples</span></a></li>
<li><a href="/news/" aria-current="page"><span>News</span></a></li>
<li><a href="/peers/"><span>Peers</span></a></li>
<li><a href="/team/"><span>Team</span></a></li>
</ul>
</nav>
<div class="mobile-nav" dir="ltr" hidden>
  <div class="mobile-nav__cover"></div>
  <button class="mobile-nav__toggle button" aria-expanded="false" aria-controls="sheet">
    Menu
    <svg class="mobile-nav__hamburger" viewBox="0 0 100 100" focusable="false" aria-hidden="true">
      <rect width="80" height="12" x="10" y="20" rx="5"></rect>
      <rect width="80" height="12" x="10" y="45" rx="5"></rect>
      <rect width="80" height="12" x="10" y="70" rx="5"></rect>
    </svg>
  </button>
  <div class="mobile-nav__sheet link-inverted link-nav" id="sheet" aria-hidden="true">
    <div class="mobile-nav__region"></div>
    <nav class="mobile-nav__main-menu" aria-label="Main menu">
    <ul class="mobile-nav__navbar">
    <li><a href="/"><span>Home</span></a></li>
    <li><a href="/start/"><span>Getting started</span></a></li>
    <li><a href="/guide/"><span>Guide</span></a></li>
    <li><a href="/examples/"><span>Examples</span></a></li>
    <li><a href="/news/" aria-current="page"><span>News</span></a></li>
    <li><a href="/peers/"><span>Peers</span></a></li>
    <li><a href="/team/"><span>Team</span></a></li>
    </ul>
    </nav>
  </div>
</div>
<main class="main layout__main">
<article class="single-view single-view--news">
<header>
<h1 class="title mb--xxs">The Tale of GoIDs</h1>
<div class="submitted meta">
<span class="author" itemprop="author">David Tolpin</span> - <time class="created-date" datetime="2019-04-01T15:19:22&#43;03:00">1 April, 2019</time>

</div>
</header>

<blockquote>
<p><strong>2.16</strong> And the LORD God commanded the man, saying: &lsquo;Of every tree of the garden
thou mayest freely eat;</p>
</blockquote>
<blockquote>
<p><strong>2.17</strong> but of the tree of the knowledge of good and evil,
thou shalt not eat of it; for in the day that thou eatest thereof thou shalt
surely die.&rsquo;</p>
<p><em>The Book of Genesis</em></p>
</blockquote>
<p><a href="http://golang.org/">Go</a> gives the programmer introspection into every aspect
of <a href="https://godoc.org/reflect">the language</a>, and of a <a href="https://godoc.org/runtime">running
program</a>. But to one thing the programmer does not
have access, and it is the goroutine identifier. Because the day the
programmers know the goroutine identifier, they create goroutine-local storage
through shared access and mutexes, and shall surely die.</p>
<p><strong>However,</strong> there are use cases beyond concurrent <a href="https://blog.golang.org/context">handling of HTTP
requests</a>, in which
<a href="https://blog.golang.org/share-memory-by-communicating">sharing memory by
communicating</a>
through channels or passing the context around is not going to
work. One such case is <a href="http://infergo.org/">Infergo</a>.  Infergo
transforms Go source code to enable <a href="https://en.wikipedia.org/wiki/Automatic_differentiation#Reverse_accumulation">reverse-mode automatic
differentiation</a>.
Function <em>signatures</em> stay unchanged, but function <em>bodies</em> are
modified to write to a so-called <em>tape</em> a trace of every
floating point operation. A single tape must be accessible by
all functions. If derivatives are computed concurrently in
multiple goroutines, every goroutine must have its own tape.</p>
<p>The functions must know how to get to the tape. And getting to
the tape must be very efficient: every floating point operation
involves an access to the tape!</p>
<p>It is not that no one thought about goroutine identifiers
before. There are Go programmers who need the identifiers, some
of them admit the need, and a few find workarounds to actually
obtain the identifiers.  I searched for the workarounds, I found
several worthy attempts, and then I had a revelation, and then I
discovered someone who had the same revelation before me. And
that gave Infergo efficient goroutine-local storage for
concurrent automatic differentiation and inference. Here is how
it went.</p>
<h2 id="worthy-attempts">Worthy Attempts</h2>
<h3 id="from-the-makers-of-go">From the makers of Go</h3>
<p><a href="https://bradfitz.com/">Brad Fitzpatrick</a> is a member of the Go
programming language team at Google. Brad wrote a
<a href="https://github.com/bradfitz/http2/blob/master/gotrack.go">function</a>
which obtains the goroutine identifier. The function creates a
stack trace and parses the identifier out of string
representation of the trace. Brad needed this for debugging, &ldquo;to
track that functions run on the goroutine  that they&rsquo;re supposed
to&rdquo;. The function uses public API calls and an undocumented but
stable format of the serialized stack trace.</p>
<p>Somewhat cumbersome but working. Unfortunately, too inefficient
for Infergo use case. Collecting, serializing, and parsing the
stack trace on every operation makes automatic differentiation
2,000 (<strong>two thousand</strong>) times slower!</p>
<h3 id="from-the-users-of-go">From the users of Go</h3>
<p><a href="https://jtolio.com/">JT Olio</a> wrote a <a href="https://github.com/jtolds/gls">goroutine-local storage
library</a>. The library &ldquo;defines 16
special functions and embed base-16 tags into the stack using
the call order of those 16 functions.&rdquo; Then, this embedding is
used to produce an unique goroutine identifier and establish
goroutine-local storage. The idea blew me away! However, the
library requires that Go routines are created through a library
call.  I could modify Infergo&rsquo;s own inference algorithms, however I
would not be able to pass functions and gradients to third-party
code. Infergo
<a href="https://bitbucket.org/dtolpin/infergo-studies/src/master/lr-gonum/">integrates</a>
with <a href="http://gonum.org/">Gonum</a> optimization nicely, and by
enabling goroutine-local tapes I strived to improve this
integration, rather than sacrifice it.</p>
<h2 id="revelation">Revelation</h2>
<p>I was almost ready to give up, that is, to write code that
adds an extra &lsquo;context&rsquo; parameter to every differentiated function.
But then it came down onto me that maybe Go does not want to
prevent me from using the goroutine identifier.  Maybe it is
there, and I just do not see it.</p>
<p>Indeed, Go has an <a href="https://golang.org/doc/asm">assembly
language</a>. The language is
documented, Go functions can be implemented in Go assembly.  If
I wanted a system feature not available through a library, I
would write an assembly function bringing that feature to me.</p>
<p>The same goes for Go.</p>
<p>Not only Go has an assembler, the assembler has a dedicated
register <code>g</code> pointing at <code>runtime.g</code>, the goroutine descriptor.
<code>goid</code>, the Go routine identifier is just one of the fields of
the descriptor. I can just use the contents of <code>g</code> to get
the goroutine identifier, and it will only be a couple
instructions!</p>
<p>It is much easier to find something if you know what you are
looking for. <a href="https://zhuanlan.zhihu.com/taowen">Tao Wen</a> wrote
yet another <a href="https://github.com/modern-go/gls">GLS library</a>; and
this library does exactly what I just described: uses Go
assembler to access register <code>g</code>, and retrieves field <code>goid</code>
from the structure pointed to by the register. I somewhat
simplified the code, added support for all platforms where
Go is available, and now Infergo has fast and straightforward
support for multithreading.</p>
<h2 id="lessons-learned">Lessons Learned</h2>
<ol>
<li>
<p>It is sometimes easier to find a hole in the fence than to
jump over.</p>
</li>
<li>
<p>You can do anything with Go. You just must prove (to yourself
more than to others) that you are brave and skilled enough.
For example, by diving into Go internals and coding in Go
assembly.</p>
</li>
<li>
<p>My Samsung Tab S4 tablet is amazingly well fit for
multithreading, in Go in particular. I did most of the
development on the tablet, in <a href="https://termux.com">Termux</a>.
The tablet&rsquo;s CPU  has 8 cores, and Go runs multiple
goroutines in parallel with very little overhead: 8 inference
threads in parallel take roughly the same time as a single
thread with local goroutine storage, and only 20% slower than
a single thread with a global tape, for the same amount of
computation per thread.</p>
</li>
<li>
<p>You can run <a href="https://bitbucket.org/dtolpin/infergo-studies/src/master/wasm/">multiple goroutines in parallel in a
browser</a> via
WebAssembly. WebAssembly is slower than other targets, but
still quite fast.</p>
</li>
</ol>


</article>
</main>


<aside class="sidebar layout__second-sidebar">
<nav class="menu">
<p class="title"><strong><a href="/peers/">Peers</a></strong></p>
<ul>
<li><a href="/peers/gogp/">GoGP</a></li>
</ul>
</nav>
<nav class="menu">
<p class="title"><strong><a href="/news/" aria-current="page">News</a></strong></p>
<ul>
<li><a href="/news/v1.2.2/">infergo v1.2.2</a></li>
<li><a href="/news/gogp-v1.0.1/">gogp v1.0.1</a></li>
<li><a href="/news/v1.0.1/">infergo v1.0.1</a></li>
<li><a href="/news/gogp/">gogp v0.1.0</a></li>
<li><a href="/news/v0.7.0/">infergo v0.7.0</a></li>
<li><a href="/news/v0.6.1/">infergo v0.6.1</a></li>
<li><a href="/news/v0.5.0/">infergo v0.5.0</a></li>
<li><a href="/news/tale-of-goids/" aria-current="page">The Tale of GoIDs</a></li>
<li><a href="/news/v0.3.0/">infergo v0.3.0</a></li>
<li><a href="/news/v0.2.2/">infergo v0.2.2</a></li>
<li><a href="/news/v0.2.1/">infergo v0.2.1</a></li>
<li><a href="/news/why/">Why infergo</a></li>
</ul>
</nav>
</aside>
<footer class="footer layout__footer mt--l">
<p><span>© Infergo – Go programs that learn</span></p>

<p>Powered by <a href="https://gohugo.io/">Hugo</a> and the <a href="https://github.com/frjo/hugo-theme-zen">Zen theme</a>.</p>

</footer>

</div>
</body>
</html>
